<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetScan Pro - Secure Your Perimeter</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    colors: {
                        // --- LIGHT THEME COLORS ---
                        'bg-light': '#FFFFFF',       // Main Page Background (White)
                        'card-light': '#F4F6F9',     // Card/Section Background (Light Gray)
                        'text-dark': '#1F2937',      // Primary Text Color (Dark Gray/Black)
                        'highlight-main': '#007BFF', // Deep Blue (Primary Accent)
                        'primary-btn': '#007BFF',    // Deep Blue
                        'secondary-btn': '#5B9DFE',  // Sky Blue
                        'danger-alert': '#DC3545',   // Standard Red for warnings
                        'border-light': '#D1D5DB',   // Light Border Color
                        
                        // --- DARK THEME COLORS ---
                        'bg-dark': '#0F172A',        // Dark Blue/Slate background
                        'card-dark': '#1E293B',      // Slightly lighter slate for cards
                        'text-light': '#F1F5F9',     // Light gray text for dark theme
                        'border-dark': '#334155',    // Dark border color
                        'terminal-bg': '#000000',    // Black for terminal (Fixed)
                        'terminal-text': '#38FF38',  // Bright Green for terminal text (Fixed)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s; /* Smooth transition */
        }

        /* Custom Button & Highlight Utilities */
        .btn-primary-custom {
            background-color: theme('colors.primary-btn');
            color: theme('colors.bg-light'); /* White text on button */
            transition: all 0.3s;
            border-width: 2px;
            border-color: theme('colors.primary-btn');
        }
        .btn-primary-custom:hover {
            background-color: transparent;
            color: theme('colors.primary-btn');
        }

        /* Hero Section Animation */
        .hero-bg-gradient {
            background: radial-gradient(circle at center top, rgba(0, 123, 255, 0.05) 0%, rgba(255, 255, 255, 1) 40%);
        }
        .dark .hero-bg-gradient {
            background: radial-gradient(circle at center top, rgba(0, 123, 255, 0.1) 0%, theme('colors.bg-dark') 40%);
        }

        /* Mock Result/Output Styling */
        .mock-result {
            transition: all 0.5s ease; 
        }

        /* Loading Bar Animation */
        .loading-fill {
            height: 100%;
            background-color: theme('colors.primary-btn');
            width: 0%;
            transition: width 2s ease-in-out;
        }

        .summary { 
            margin-top: 15px; 
            padding: 10px; 
            background-color: theme('colors.danger-alert'); /* Standard Red for high visibility */
            border-radius: 0.375rem; 
            color: theme('colors.bg-light'); /* White text on red background */
            font-weight: 600;
        }

        /* Custom Hover Effect for Steps/Cards (Updated Border) */
        .card-hover-effect:hover {
            transform: translateY(-5px);
            border-color: theme('colors.primary-btn');
        }

        /* AI Analysis Specific Styles */
        .ai-analysis-container {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid theme('colors.primary-btn');
            border-radius: 8px;
            background-color: theme('colors.bg-light');
            text-align: left;
        }
        .dark .ai-analysis-container {
            background-color: theme('colors.card-dark');
        }
        .ai-analysis-title {
            color: theme('colors.primary-btn');
            font-weight: bold;
            border-bottom: 1px solid theme('colors.border-light');
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .dark .ai-analysis-title {
            border-bottom-color: theme('colors.border-dark');
        }

        /* Style for the actual terminal output: BLACK Background, GREEN Text (FIXED) */
        #scanOutput pre {
            white-space: pre-wrap; 
            word-wrap: break-word;
            font-family: monospace;
            overflow-x: auto;
            /* Enforced Terminal Style for all themes */
            color: theme('colors.terminal-text'); /* Bright Green */
            background-color: theme('colors.terminal-bg'); /* Black */
            border: 1px solid theme('colors.terminal-text'); /* Green Border for Aesthetic */
            padding: 1rem;
            border-radius: 0.375rem;
        }

        /* Tab Switcher Styles adaptation */
        .tab-option {
            flex: 1;
            text-align: center;
            padding: 0.6rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .tab-option.active {
            background: theme('colors.highlight-main');
            color: theme('colors.bg-light');
            border-radius: 6px;
        }
        .tab-option:not(.active) {
            color: theme('colors.text-dark');
        }
        .dark .tab-option:not(.active) { /* Dark mode styling for inactive tab */
            color: theme('colors.text-light');
        }
    </style>
</head>
<body class="antialiased bg-bg-light dark:bg-bg-dark text-text-dark dark:text-text-light">

    <!-- Header & Navigation -->
    <header class="bg-card-light dark:bg-card-dark shadow-lg border-b-4 border-highlight-main sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center flex-wrap">
            <h1 class="text-2xl font-extrabold text-text-dark dark:text-text-light">NetScan<span class="text-highlight-main">Pro</span></h1>
            <nav class="flex items-center space-x-4 mt-3 sm:mt-0">
                <a href="#features" class="text-text-dark dark:text-text-light hover:text-highlight-main transition duration-300 hidden sm:inline">Features</a>
                
                <!-- Dark Mode Toggle Switch -->
                <button id="themeToggle" class="p-2 rounded-full text-text-dark dark:text-text-light hover:bg-card-light dark:hover:bg-border-dark transition duration-300">
                    <i id="themeIcon" class="fas fa-sun text-xl"></i> 
                </button>
            </nav>
        </div>
    </header>

    <!-- 1. Hero Section -->
    <section id="hero" class="hero-bg-gradient text-center py-16 sm:py-24">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-5xl sm:text-6xl font-extrabold mb-4 leading-tight">
                Secure Your Perimeter. <br> Instant Port Scans with 
                <span class="text-highlight-main">Enterprise-Grade Accuracy</span>.
            </h2>
            <p class="text-xl text-gray-600 dark:text-text-light mb-8">
                Find open ports, map your attack surface, and uncover hidden network vulnerabilities in seconds.
            </p>

            <!-- Status Indicator -->
            <div id="status" class="text-center font-bold text-lg mb-4 text-gray-600 dark:text-text-light">Idle</div>

            <!-- Scan Form and Inputs -->
            <div class="card bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-2xl max-w-xl mx-auto border border-border-light dark:border-border-dark">
                <form id="scanForm" class="text-left">
                    <label for="targetInput" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Target (domain or IP)</label>
                    <input name="target" id="targetInput" type="text" value="scanme.nmap.org" required
                           class="p-3 w-full border border-border-light dark:border-border-dark bg-bg-light dark:bg-card-dark text-text-dark dark:text-text-light rounded-lg focus:outline-none focus:border-highlight-main mb-4" />

                    <!-- Toggle switcher -->
                    <div class="flex bg-card-light dark:bg-card-dark rounded-lg overflow-hidden border border-border-light dark:border-border-dark mb-4 text-sm p-1">
                        <div id="tabDefault" class="tab-option active">Default scan (1–1024)</div>
                        <div id="tabCustom" class="tab-option">Custom port range</div>
                    </div>

                    <!-- Custom input fields -->
                    <div id="customInputs" class="space-y-4" style="display:none;">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="startPort" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Start port</label>
                                <input name="start" id="startPort" type="number" value="1" min="1" max="65535"
                                       class="p-3 w-full border border-border-light dark:border-border-dark bg-bg-light dark:bg-card-dark text-text-dark dark:text-text-light rounded-lg focus:outline-none focus:border-highlight-main" />
                            </div>
                            <div>
                                <label for="endPort" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">End port</label>
                                <input name="end" id="endPort" type="number" value="1024" min="1" max="65535"
                                       class="p-3 w-full border border-border-light dark:border-border-dark bg-bg-light dark:bg-card-dark text-text-dark dark:text-text-light rounded-lg focus:outline-none focus:border-highlight-main" />
                            </div>
                        </div>
                    </div>

                    <label for="concurrency" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300 mt-4">Concurrency (Max 2000)</label>
                    <input name="concurrency" id="concurrency" type="number" value="500" min="1" max="2000"
                           class="p-3 w-full border border-border-light dark:border-border-dark bg-bg-light dark:bg-card-dark text-text-dark dark:text-text-light rounded-lg focus:outline-none focus:border-highlight-main mb-4" />

                    <div class="flex items-center mb-6">
                        <input id="noBanner" name="no_banner" type="checkbox"
                               class="h-4 w-4 text-primary-btn border-border-light dark:border-border-dark rounded focus:ring-primary-btn mr-2" />
                        <label for="noBanner" class="text-gray-700 font-medium m-0 dark:text-gray-300">Skip banner reads (Faster scan, less detail)</label>
                    </div>

                    <div class="flex items-center gap-4">
                        <button id="startBtn" type="submit" class="btn-primary-custom px-6 py-3 text-lg font-bold rounded-lg flex-1">
                            <i class="fas fa-rocket mr-2"></i> Start Scan
                        </button>
                    </div>
                    <div class="text-sm text-gray-500 mt-3 dark:text-gray-400">
                        Only scan systems you own or have permission to scan. Max port range 2000.
                    </div>
                </form>
            </div>

            <p class="text-sm text-gray-500 mt-3 dark:text-gray-400">Powered by the NetScan Engine | Trusted by 10,000+ SecOps Teams</p>

            <!-- Scan Result Container -->
            <div id="mockResult" class="mock-result mt-10 p-5 bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg text-left shadow-lg max-w-4xl mx-auto" style="display: none;">
                <div id="scanOutput">
                    <!-- Scan output (plain text from Flask) will go here -->
                </div>
            </div>
        </div>
    </section>

    <!-- 2. How It Works -->
    <section id="how-it-works" class="py-20 bg-bg-light dark:bg-bg-dark">
        <div class="max-w-7xl mx-auto px-4">
            <h3 class="text-4xl font-bold text-center mb-16">How It Works: Security in 3 Simple Steps</h3>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="step p-6 bg-card-light dark:bg-card-dark rounded-xl border-t-4 border-border-light dark:border-border-dark transition duration-300 card-hover-effect shadow">
                    <i class="fas fa-keyboard text-4xl text-highlight-main mb-4"></i>
                    <h4 class="text-xl font-semibold mb-2">1. Define Target</h4>
                    <p class="text-gray-600 dark:text-text-light">Enter the IP or Domain. Choose your scan type (Quick Top Ports, Full Range, or Stealth/SYN Scan).</p>
                </div>
                <div class="step p-6 bg-card-light dark:bg-card-dark rounded-xl border-t-4 border-border-light dark:border-border-dark transition duration-300 card-hover-effect shadow">
                    <i class="fas fa-bolt text-4xl text-highlight-main mb-4"></i>
                    <h4 class="text-xl font-semibold mb-2">2. Execute Scan</h4>
                    <p class="text-gray-600 dark:text-text-light">Our cloud-hosted engine uses optimized techniques like SYN scans for lightning-fast and non-intrusive probing.</p>
                </div>
                <div class="step p-6 bg-card-light dark:bg-card-dark rounded-xl border-t-4 border-border-light dark:border-border-dark transition duration-300 card-hover-effect shadow">
                    <i class="fas fa-file-invoice text-4xl text-highlight-main mb-4"></i>
                    <h4 class="text-xl font-semibold mb-2">3. Get Actionable Results</h4>
                    <p class="text-gray-600 dark:text-text-light">Instantly receive a clear, classified report showing port status, service versions, and security recommendations.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Key Features & Benefits -->
    <section id="features" class="py-20 bg-card-light dark:bg-card-dark border-y border-border-light dark:border-border-dark">
        <div class="max-w-7xl mx-auto px-4">
            <h3 class="text-4xl font-bold text-center mb-16">Why Choose NetScan Pro?</h3>
            <div class="grid lg:grid-cols-4 md:grid-cols-2 gap-10">
                <div class="feature-card text-center p-4">
                    <i class="fas fa-tachometer-alt text-3xl text-secondary-btn mb-3"></i>
                    <h4 class="text-xl font-semibold mb-2">Speed & Efficiency</h4>
                    <p class="text-gray-600 dark:text-text-light">Quick top-port scans for immediate reconnaissance and scalable scanning for entire IP ranges.</p>
                </div>
                <div class="feature-card text-center p-4">
                    <i class="fas fa-shield-alt text-3xl text-secondary-btn mb-3"></i>
                    <h4 class="text-xl font-semibold mb-2">Accuracy & Depth</h4>
                    <p class="text-gray-600 dark:text-text-light">Industry-standard scanning techniques and detailed service version detection on open ports.</p>
                </div>
                <div class="feature-card text-center p-4">
                    <i class="fas fa-cogs text-3xl text-secondary-btn mb-3"></i>
                    <h4 class="text-xl font-semibold mb-2">Reporting & Workflow</h4>
                    <p class="text-gray-600 dark:text-text-light">Actionable reports with clear status (Open, Closed, Filtered) and easy export options (CSV/PDF).</p>
                </div>
                <div class="feature-card text-center p-4">
                    <i class="fas fa-user-secret text-3xl text-secondary-btn mb-3"></i>
                    <h4 class="text-xl font-semibold mb-2">Stealth Scanning</h4>
                    <p class="text-gray-600 dark:text-text-light">Utilize half-open SYN scans for authorized testing that minimizes logging and detection.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. Testimonials -->
    <section id="testimonials" class="py-20 bg-card-light dark:bg-card-dark border-y border-border-light dark:border-border-dark">
        <div class="max-w-4xl mx-auto px-4">
            <h3 class="text-4xl font-bold text-center mb-12">Trusted by Professionals</h3>
            <div class="p-8 sm:p-12 bg-bg-light dark:bg-card-dark border border-primary-btn rounded-xl text-center shadow-2xl">
                <p class="italic text-xl mb-4 text-gray-700 dark:text-text-light">"Switched from CLI Nmap to this tool. The speed and the clear, actionable reports have saved my team hours every week. Essential for modern SecOps."</p>
                <p class="font-semibold text-lg text-secondary-btn">- **Mark H.** | Senior Network Engineer at TechCorp</p>
            </div>
        </div>
    </section>

    <!-- 5. Final Call-to-Action -->
    <section id="final-cta" class="py-24 text-center bg-bg-light dark:bg-bg-dark">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-4xl sm:text-5xl font-extrabold mb-8">Ready to See What Your Network is Hiding?</h2>
            <a href="#" class="btn-primary-custom px-10 py-5 text-2xl font-bold rounded-lg">Start Your Free Scan Now</a>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-card-light dark:bg-card-dark py-6 text-center border-t border-border-light dark:border-border-dark">
        <div class="max-w-7xl mx-auto px-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">
                &copy; 2025 NetScanPro. All rights reserved. | 
                <a href="#" class="hover:text-highlight-main transition duration-300">Privacy Policy</a> | 
                <a href="#" class="hover:text-highlight-main transition duration-300">Terms of Service</a>
            </p>
        </div>
    </footer>

    <!-- JavaScript for interactivity and theme switching -->
    <script>
        #!/usr/bin/env python3
"""
app.py - Flask frontend + API for the async port scanner.

Requirements:
  - Flask
  - your scanner module (port_scanner.py) in the same repo

Deploy notes:
  - On Render, use a single gunicorn worker (or implement external job persistence)
    Start command example:
      gunicorn app:app --workers 1 --threads 4 --bind 0.0.0.0:$PORT
"""

import os
import time
import uuid
import logging
import subprocess
from typing import Tuple, Dict, Any
from concurrent.futures import ThreadPoolExecutor, Future

from flask import Flask, render_template, request, jsonify, Response

# -------------------------
# Try to import scanner helpers (be resilient if parse_nmap_aggressive is missing)
# -------------------------
try:
    # your scanner module (the file you posted; ensure it's named port_scanner.py)
    from port_scanner import (
        run_scan_sync,
        analyze_results,
        format_scan_results,
        run_nmap_service_scan,
        parse_nmap_aggressive,
    )
except Exception as e:
    # If parse_nmap_aggressive isn't present, import what we can and create a stub parser
    logging.warning("port_scanner import incomplete: %s", e)
    try:
        from port_scanner import run_scan_sync, analyze_results, format_scan_results, run_nmap_service_scan
    except Exception as inner:
        # If even basic functions are missing, raise so the app won't start silently broken.
        raise

    def parse_nmap_aggressive(nmap_out: str) -> dict:
        """Fallback parser - minimal structure so app doesn't crash."""
        return {"ports": [], "host_up": None, "os_text": None, "service_info": None, "traceroute": []}


# -------------------------
# Flask app setup
# -------------------------
app = Flask(__name__, static_folder="static", template_folder="templates")
logging.basicConfig(level=logging.INFO)

# In-memory job store and executor (simple, not shared across processes)
jobs: Dict[str, Dict[str, Any]] = {}
executor = ThreadPoolExecutor(max_workers=4)

# Limits (same as your scanner)
MAX_PORT_RANGE = 2000
MAX_CONCURRENCY = 2000

INSECURE_NOTES = {
    "telnet": "Telnet is insecure (plaintext).",
    "ftp": "FTP transmits credentials in cleartext.",
}


# -------------------------
# Helpers
# -------------------------
def validate_params(target: str, start: int, end: int, concurrency: int):
    if not target:
        raise ValueError("target required")
    if start < 1 or end > 65535 or start > end:
        raise ValueError("invalid port range")
    if (end - start + 1) > MAX_PORT_RANGE:
        raise ValueError(f"port range too large (limit {MAX_PORT_RANGE})")
    if concurrency < 1 or concurrency > MAX_CONCURRENCY:
        raise ValueError("invalid concurrency")


def run_scan_task(target: str, start: int, end: int, concurrency: int,
                  connect_timeout: float, read_timeout: float, rate_delay: float, jitter: float,
                  no_banner: bool, use_nmap: bool = False, aggressive: bool = False) -> dict:
    """
    Execute the scanning pipeline:
      - run async scanner via run_scan_sync
      - analyze results
      - optionally run/parse nmap and merge
      - produce _formatted text for UI
    """
    try:
        # run the scanner (this should return tuple (ip, raw_results) based on your scanner)
        ip, raw = run_scan_sync(target, start, end, concurrency,
                                connect_timeout, (0.01 if no_banner else read_timeout),
                                rate_delay, jitter)

        enriched = analyze_results(raw)

        result_obj = {
            "status": "done",
            "target": target,
            "resolved_ip": ip,
            "start": start,
            "end": end,
            "results": enriched,
            "scanned_at": time.time()
        }

        # Optionally run nmap and parse results
        if use_nmap:
            logging.info("Invoking nmap for %s ports=%s aggressive=%s", target, f"{start}-{end}", aggressive)
            nmap_out = run_nmap_service_scan(target, ports=f"{start}-{end}", aggressive=aggressive)
            if nmap_out:
                nmap_info = parse_nmap_aggressive(nmap_out)
                result_obj["_nmap"] = nmap_info

                # merge nmap ports into enriched if not already present
                nm_by_port = {p["port"]: p for p in nmap_info.get("ports", [])}
                ports_seen = {r["port"] for r in enriched}
                for port, nm in nm_by_port.items():
                    if port not in ports_seen:
                        enriched.append({
                            "port": port,
                            "state": nm.get("state", "unknown"),
                            "service_hint": None,
                            "detected_service": nm.get("service"),
                            "version": nm.get("version"),
                            "banner": None,
                            "insecure_note": INSECURE_NOTES.get(nm.get("service")) if nm.get("service") else None,
                            "rtt_ms": 0.0,
                        })
                enriched.sort(key=lambda x: x["port"])
                result_obj["results"] = enriched

        # Format for UI (best-effort)
        try:
            result_obj["_formatted"] = format_scan_results(result_obj)
        except Exception:
            logging.exception("format_scan_results failed")

        return result_obj

    except Exception as e:
        logging.exception("run_scan_task failed for %s", target)
        return {"status": "error", "error": str(e)}


def create_scan_job(target: str, start: int, end: int, concurrency: int,
                    connect_timeout: float, read_timeout: float, rate_delay: float, jitter: float,
                    no_banner: bool, use_nmap: bool = False, aggressive: bool = False) -> Tuple[str, dict]:
    job_id = str(uuid.uuid4())
    created = time.time()

    def worker():
        return run_scan_task(target, start, end, concurrency,
                             connect_timeout, read_timeout, rate_delay, jitter,
                             no_banner, use_nmap=use_nmap, aggressive=aggressive)

    future = executor.submit(worker)
    jobs[job_id] = {"future": future, "created": created, "params": {"target": target, "start": start, "end": end, "use_nmap": use_nmap, "aggressive": aggressive}}
    return job_id, jobs[job_id]


# -------------------------
# Routes
# -------------------------
@app.route("/")
def index():
    # Serve templates/index.html — ensure file exists in templates/
    return render_template("index.html")


@app.route("/scan-blocking", methods=["POST"])
def scan_blocking():
    """
    Blocking endpoint that runs the scan synchronously and returns text output.
    Accepts either 'target' or 'host' field.
    """
    data = request.get_json() or request.form
    try:
        target = data.get("target") or data.get("host")
        if not target:
            raise ValueError("target (or host) required")

        start = int(data.get("start", 1))
        end = int(data.get("end", 1024))
        concurrency = int(data.get("concurrency", 200))
        connect_timeout = float(data.get("connect_timeout", 3.0))
        read_timeout = float(data.get("read_timeout", 2.0))
        rate_delay = float(data.get("rate_delay", 0.0))
        jitter = float(data.get("jitter", 0.02))
        no_banner = bool(data.get("no_banner", False))
        use_nmap = bool(data.get("use_nmap", False))
        aggressive = bool(data.get("aggressive", False))

        validate_params(target, start, end, concurrency)
    except Exception as e:
        return jsonify({"status": "error", "error": str(e)}), 400

    try:
        result_obj = run_scan_task(target, start, end, concurrency,
                                   connect_timeout, read_timeout, rate_delay, jitter,
                                   no_banner, use_nmap=use_nmap, aggressive=aggressive)
        formatted = result_obj.get("_formatted") or format_scan_results(result_obj)
        return Response(formatted, mimetype="text/plain")
    except Exception as e:
        logging.exception("scan_blocking failed")
        return jsonify({"status": "error", "error": str(e)}), 500


@app.route("/scan", methods=["POST"])
def scan():
    """
    Non-blocking: create background job and return job_id.
    Accepts JSON/form with 'target' or 'host'.
    """
    data = request.get_json() or request.form
    try:
        target = data.get("target") or data.get("host")
        if not target:
            return jsonify({"status": "error", "error": "target (or host) parameter required"}), 400

        start = int(data.get("start", 1))
        end = int(data.get("end", 1024))
        concurrency = int(data.get("concurrency", 200))
        connect_timeout = float(data.get("connect_timeout", 3.0))
        read_timeout = float(data.get("read_timeout", 2.0))
        rate_delay = float(data.get("rate_delay", 0.0))
        jitter = float(data.get("jitter", 0.02))
        no_banner = bool(data.get("no_banner", False))
        use_nmap = bool(data.get("use_nmap", False))
        aggressive = bool(data.get("aggressive", False))

        validate_params(target, start, end, concurrency)
    except Exception as e:
        return jsonify({"status": "error", "error": str(e)}), 400

    job_id, job_meta = create_scan_job(target, start, end, concurrency,
                                       connect_timeout, read_timeout, rate_delay, jitter, no_banner,
                                       use_nmap=use_nmap, aggressive=aggressive)
    return jsonify({"status": "submitted", "job_id": job_id, "created": job_meta["created"], "params": job_meta["params"]})


@app.route("/scan-status/<job_id>", methods=["GET"])
def scan_status(job_id):
    meta = jobs.get(job_id)
    if not meta:
        return jsonify({"status": "error", "error": "job not found"}), 404

    future: Future = meta["future"]
    want_text = request.args.get("format", "").lower() in ("txt", "text", "plain")
    if future.done():
        result = future.result()
        if want_text:
            formatted = result.get("_formatted") or format_scan_results(result)
            return Response(formatted, mimetype="text/plain")
        else:
            return jsonify({"status": result.get("status", "done"), "result": result})
    else:
        return jsonify({"status": "running", "created": meta["created"], "params": meta["params"]})


# -------------------------
# Direct nmap subprocess endpoint (optional)
# -------------------------
@app.route("/nmap", methods=["POST"])
def run_nmap_subprocess():
    """
    Runs the system nmap binary (if present).
    Accepts JSON/form:
      - target (or host)
      - ports (default 1-65535)
      - aggressive (bool) -> include -A
      - timing (0-5)
      - timeout (seconds)
    Security: we build cmd list (no shell); still be careful exposing this in public.
    """
    data = request.get_json() or request.form
    target = data.get("target") or data.get("host")
    if not target:
        return jsonify({"status": "error", "error": "target (or host) required"}), 400

    ports = data.get("ports", "1-65535")
    aggressive = bool(data.get("aggressive", False))
    timing = str(int(data.get("timing", 4)))
    timeout_sec = int(data.get("timeout", 300))

    cmd = ["nmap", f"-T{timing}", "-p", ports]
    if aggressive:
        cmd.append("-A")
    else:
        cmd.append("-sV")
    cmd.append(target)

    logging.info("Running nmap: %s", " ".join(cmd))
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout_sec)
        return jsonify({"status": "done" if proc.returncode == 0 else "error", "returncode": proc.returncode, "stdout": proc.stdout, "stderr": proc.stderr})
    except subprocess.TimeoutExpired:
        return jsonify({"status": "error", "error": "nmap timed out"}), 504
    except FileNotFoundError:
        return jsonify({"status": "error", "error": "nmap binary not found"}), 500
    except Exception as e:
        logging.exception("nmap subprocess failed")
        return jsonify({"status": "error", "error": str(e)}), 500


# -------------------------
# Health
# -------------------------
@app.route("/status")
def status():
    return jsonify({"status": "ok", "time": time.time()})
        
    </script>
</body>
</html>

